# =============================================================================
# Auth Service Server Configuration
# Endpoint-specific rate limiting + Reverse Proxy
# =============================================================================

server {
    listen 80;
    server_name localhost;

    # Include security headers
    include /etc/nginx/snippets/security-headers.conf;

    # Connection limit per IP
    limit_conn conn_limit 10;

    # Default rate limit for all requests
    limit_req zone=global burst=10 nodelay;
    limit_req_status 429;

    # Custom error pages for rate limiting
    error_page 429 @rate_limited;

    location @rate_limited {
        default_type application/json;
        return 429 '{"error": "rate_limit_exceeded", "message": "Too many requests. Please try again later.", "retryAfter": 60}';
    }

    # ==========================================================================
    # HEALTH CHECK ENDPOINTS (No rate limiting)
    # ==========================================================================
    location /actuator/health {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # No rate limiting for health checks
        limit_req off;
    }

    # ==========================================================================
    # OTP SEND ENDPOINT - Strictest rate limiting (SMS bombing prevention)
    # ==========================================================================
    location /auth/otp/send {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # 1 request per 10 seconds per IP (6 per minute)
        limit_req zone=otp_send burst=2 nodelay;

        # Custom error for OTP rate limit
        error_page 429 @otp_rate_limited;
    }

    location @otp_rate_limited {
        default_type application/json;
        return 429 '{"error": "rate_limit_exceeded", "message": "Please wait before requesting another OTP.", "retryAfter": 10}';
    }

    # ==========================================================================
    # OTP VERIFY ENDPOINT - Brute force protection
    # ==========================================================================
    location /auth/otp/verify {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # 1 request per 2 seconds per IP (30 per minute)
        limit_req zone=otp_verify burst=3 nodelay;

        error_page 429 @verify_rate_limited;
    }

    location @verify_rate_limited {
        default_type application/json;
        return 429 '{"error": "rate_limit_exceeded", "message": "Too many verification attempts. Please wait.", "retryAfter": 5}';
    }

    # ==========================================================================
    # PASSKEY/AUTH LOGIN ENDPOINT
    # ==========================================================================
    location /auth/login {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # 1 request per 2 seconds per IP
        limit_req zone=auth_login burst=3 nodelay;
    }

    # ==========================================================================
    # TOKEN REFRESH ENDPOINT
    # ==========================================================================
    location /auth/refresh {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # 1 request per second per IP
        limit_req zone=token_refresh burst=2 nodelay;
    }

    # ==========================================================================
    # PASSKEY REGISTRATION ENDPOINTS
    # ==========================================================================
    location ~ ^/auth/passkey/(register|register/finish) {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # Same as login rate limit
        limit_req zone=auth_login burst=3 nodelay;
    }

    # ==========================================================================
    # ALL OTHER AUTH ENDPOINTS
    # ==========================================================================
    location /auth/ {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # Use global rate limit
        limit_req zone=global burst=5 nodelay;
    }

    # ==========================================================================
    # CATCH-ALL FOR OTHER ENDPOINTS
    # ==========================================================================
    location / {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://auth_backend;

        # Global rate limit
        limit_req zone=global burst=10 nodelay;
    }
}
